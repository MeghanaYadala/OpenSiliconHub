name: Manual Synthesis

on:
  workflow_dispatch:
    inputs:
      verilog_file:
        description: "Path to the Verilog source file"
        required: true
        default: "RTL/ALU.v"
      top_module:
        description: "Top module name for synthesis"
        required: true
        default: "ALU"

jobs:
  synthesize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup OSS CAD Suite
        uses: YosysHQ/setup-oss-cad-suite@v2

      - name: Synthesis for iCE40UP5K
        run: |
          yosys -p "read_verilog ${{ github.event.inputs.verilog_file }}; synth_ice40 -top ${{ github.event.inputs.top_module }} -json design_ice40.json"
          nextpnr-ice40 --up5k --json design_ice40.json --asc design_ice40.asc
          icetime -d up5k -c 12 design_ice40.asc > ice40_report.txt

      - name: Synthesis for Artix-7 XC7A35T
        run: |
          yosys -p "read_verilog ${{ github.event.inputs.verilog_file }}; synth_xilinx -top ${{ github.event.inputs.top_module }} -json design_xilinx.json"
          nextpnr-xilinx --chipdb xc7a35t.bin --json design_xilinx.json --fasm design_xilinx.fasm
          echo "Artix-7 synthesis complete" > artix7_report.txt

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: synthesis-reports
          path: |
            ice40_report.txt
            artix7_report.txt
