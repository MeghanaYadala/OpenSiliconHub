name: Verilog Simulation

on:
  workflow_dispatch:   # Manual trigger only

jobs:
  simulate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install Icarus Verilog
      run: sudo apt-get update && sudo apt-get install -y iverilog

    - name: Compile and run all testbenches
      run: |
        echo "Searching for RTL + Testbench pairs under /SRC..."
        status=0
        for tb in $(find SRC -type f -name "Testbench.sv"); do
          module_dir=$(dirname "$tb")
          rtl_file="$module_dir/RTL.v"
          if [ -f "$rtl_file" ]; then
            echo "--------------------------------------------"
            echo "Compiling and running testbench in $module_dir ..."
            iverilog -g2012 -o simv "$rtl_file" "$tb" && vvp simv || status=1
            echo "--------------------------------------------"
          else
            echo "WARNING: No RTL.v found for $tb"
            status=1
          fi
        done
        exit $status
